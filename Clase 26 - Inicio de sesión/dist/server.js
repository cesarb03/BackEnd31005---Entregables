(()=>{"use strict";var e={514:e=>{e.exports=require("knex")}},t={};function n(o){var i=t[o];if(void 0!==i)return i.exports;var r=t[o]={exports:{}};return e[o](r,r.exports,n),r.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{const e=require("express");var t=n.n(e);const o=require("socket.io"),i=require("path");var r=n.n(i);const s=require("dotenv");var c=n.n(s);c().config();const a={mongoDB:{URI:`mongodb+srv://${process.env.DB_USER}:${process.env.DB_PASSWORD}@${process.env.DB_CLUSTER}.mongodb.net/${process.env.DB_NAME}?retryWrites=true&w=majority`}},d={client:"mysql",connection:{host:"127.0.0.1",port:3306,user:"root",password:"",database:process.env.DB_MARIADB_NAME},pool:{min:0,max:7}};var l=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const u=new class{constructor(e,t){this.productList=[],this.db=n(514)(e),this.table=t,this.createTableIfNotExists()}createTableIfNotExists(){return l(this,void 0,void 0,(function*(){if(!(yield this.db.schema.hasTable(this.table)))try{yield this.db.schema.createTableIfNotExists(this.table,(e=>{e.increments("id").primary(),e.string("title"),e.integer("price"),e.string("thumbnail"),e.integer("timestamp")}))}catch(e){console.error(e)}}))}getAll(){return l(this,void 0,void 0,(function*(){return yield this.db.select("*").from(this.table)}))}getById(e){return l(this,void 0,void 0,(function*(){try{return(yield this.db.select("*").where("id",e).from(this.table))||{error:"Product not found."}}catch(e){console.log("Method getById: ",e)}return{error:"Fetch item method failed"}}))}addProduct(e){return l(this,void 0,void 0,(function*(){try{const t=Date.now();yield this.db.insert(Object.assign(Object.assign({},e),{timestamp:t})).into(this.table)}catch(e){console.log("Method save: ",e)}}))}updateProductById(e,t){return l(this,void 0,void 0,(function*(){try{yield this.db.where("id",e).update({title:t.name,price:t.price,thumbnail:t.photoURL}).from(this.table)}catch(e){console.log("Method update: ",e)}}))}deleteProductById(e){return l(this,void 0,void 0,(function*(){try{yield this.db.delete("*").where("id",e).from(this.table)}catch(e){console.log("Method deleteById: ",e)}}))}}(d,"products"),h=require("fs");var v=n.n(h);const f=require("normalizr"),g=(e,t)=>{const n=new f.schema.Entity("author",{},{idAttribute:"email"}),o=new f.schema.Entity("message",{author:n},{idAttribute:"id"}),i=new f.schema.Entity("messages",{messages:[o]},{idAttribute:"id"});return"normalize"==e?(0,f.normalize)({id:"messages",messages:t},i):(0,f.denormalize)(t.result,i,t.entities)},m=require("util");var p=n.n(m),y=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};function w(e){console.log(p().inspect(e,!1,12,!0))}const b=new class extends class{constructor(e){this.filePath=e,v().existsSync(`./${this.filePath}`)||v().promises.writeFile(`./${this.filePath}`,"").then((()=>console.log(`${this.filePath} created`)))}}{constructor(){super("./src/db/chat.json")}readChatFromFile(){return y(this,void 0,void 0,(function*(){try{const e=yield v().promises.readFile(this.filePath,"utf8"),t=JSON.parse(e),n=g("denormalize",t);return console.log("Denormalized"),w(n),n}catch(e){console.log("File cannot be read "+e)}}))}writeChatToFile(e){return y(this,void 0,void 0,(function*(){try{const t=g("normalize",e);console.log("Normalized"),w(t),yield v().promises.writeFile(this.filePath,JSON.stringify(t,null,2))}catch(e){console.log("File cannot be written "+e)}}))}},x=require("cookie-parser");var P=n.n(x);const q=require("express-session");var S=n.n(q);const F=require("passport");var z=n.n(F);const A=require("connect-mongo");var B=n.n(A);const R=require("passport-local"),U=require("mongoose");var D=n.n(U);const I=require("bcrypt");var O=n.n(I),_=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const N=new(D().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0}},{collection:"users"});N.pre("save",(function(e){return _(this,void 0,void 0,(function*(){const t=this;if(!t)return e();try{const n=yield O().genSalt(10),o=yield O().hash(t.password,n);t.password=o,e()}catch(t){e(t)}}))})),N.methods.comparePassword=(e,t)=>_(void 0,void 0,void 0,(function*(){return yield O().compareSync(e,t)}));const $=D().model("User",N);var j=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const E=(0,e.Router)();z().use("login",new R.Strategy({usernameField:"email",passwordField:"password"},((e,t,n)=>{return o=void 0,i=void 0,s=function*(){try{const o=yield $.findOne({email:e}).exec();return o?(yield o.comparePassword(t,o.password))?(console.log(o),n(null,o)):n(null,!1,{message:"Wrong password"}):n(null,!1,{message:"User doesn't exist"})}catch(e){n(e)}},new((r=void 0)||(r=Promise))((function(e,t){function n(e){try{a(s.next(e))}catch(e){t(e)}}function c(e){try{a(s.throw(e))}catch(e){t(e)}}function a(t){var o;t.done?e(t.value):(o=t.value,o instanceof r?o:new r((function(e){e(o)}))).then(n,c)}a((s=s.apply(o,i||[])).next())}));var o,i,r,s}))),E.get("/",((e,t)=>{e.isAuthenticated()?t.redirect("/"):t.render("login")})),E.post("/",z().authenticate("login",{failureRedirect:"/login/failed",failureFlash:!0}),((e,t,n)=>j(void 0,void 0,void 0,(function*(){t.status(200).render("home",{user:e.user}),n()})))),E.get("/failed",((e,t)=>{t.status(401).render("failedLogin",{message:e.flash("error")[0]})}));const M=E,T=(0,e.Router)();T.post("/",((e,t)=>{e.session.destroy((()=>{t.render("login")}))}));const C=T;const L=(0,e.Router)();z().use("register",new R.Strategy({usernameField:"email",passwordField:"password"},((e,t,n)=>{return o=void 0,i=void 0,s=function*(){const o=new $({email:e,password:t});try{return yield o.save(),n(null,o)}catch(e){return 11e3===e.code?n(null,!1,{message:"User already exists"}):(console.log(e),n(e))}},new((r=void 0)||(r=Promise))((function(e,t){function n(e){try{a(s.next(e))}catch(e){t(e)}}function c(e){try{a(s.throw(e))}catch(e){t(e)}}function a(t){var o;t.done?e(t.value):(o=t.value,o instanceof r?o:new r((function(e){e(o)}))).then(n,c)}a((s=s.apply(o,i||[])).next())}));var o,i,r,s}))),L.get("/",((e,t)=>j(void 0,void 0,void 0,(function*(){e.isAuthenticated()?t.redirect("/"):t.render("register")})))),L.post("/",z().authenticate("register",{failureRedirect:"/register/failed",failureFlash:!0}),((e,t,n)=>j(void 0,void 0,void 0,(function*(){t.status(201).render("createdUser",{user:e.user}),n()})))),L.get("/failed",((e,t)=>j(void 0,void 0,void 0,(function*(){t.status(409).render("failedRegister",{message:e.flash("error")[0]})}))));const k=L,J=require("connect-flash");var W=n.n(J),G=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};c().config();const H=process.env.PORT,K=t()(),Q=K.listen(H,(()=>{console.log(`Server listening on port: ${H}`)})),V=new o.Server(Q);K.use(t().static(r().join(__dirname,"../public"))),K.use(P()()),K.use(t().json()),K.use(t().urlencoded({extended:!0})),K.set("views",r().join(__dirname,"../views")),K.set("view engine","ejs");const X={useNewUrlParser:!0,useUnifiedTopology:!0};K.use(S()({store:B().create({mongoUrl:a.mongoDB.URI,mongoOptions:X}),secret:"coderhouse",resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:6e5}})),D().connect(a.mongoDB.URI,X,(e=>{try{console.log("Connected to MongoDB Atlas")}catch(e){throw e}})),K.use(z().initialize()),K.use(z().session()),K.use(W()()),z().serializeUser(((e,t)=>{t(null,e._id)})),z().deserializeUser(((e,t)=>G(void 0,void 0,void 0,(function*(){const n=yield $.findById(e);t(null,n)})))),K.use("/login",M),K.use("/logout",C),K.use("/register",k),K.get("/",((e,t,n)=>e.isAuthenticated()?n():t.render("unauthorized")),((e,t)=>G(void 0,void 0,void 0,(function*(){t.render("home",{logged:!0,user:e.user})}))));let Y=[];V.on("connection",(e=>G(void 0,void 0,void 0,(function*(){console.log(`Se conectÃ³ un usuario: ${e.id}`),e.emit("server:product",yield u.getAll()),e.emit("server:message",Y),e.on("client:product",(e=>G(void 0,void 0,void 0,(function*(){u.addProduct(e),V.emit("server:product",yield u.getAll())})))),e.on("client:message",(e=>G(void 0,void 0,void 0,(function*(){e.id=Y.length+1,Y.push(e),b.writeChatToFile(Y);const t=Y,n=g("normalize",Y),o=JSON.stringify(n).length,i=JSON.stringify(t).length;let r=Math.round(100*o/i);console.log(`Compression Rate: ${(100-r).toFixed(2)}%`),console.log(`Length Normalized: ${o}`),console.log(`Length Denormalized: ${i}`),V.emit("server:message",Y)}))))}))))})()})();