(()=>{"use strict";var e={514:e=>{e.exports=require("knex")}},t={};function o(n){var i=t[n];if(void 0!==i)return i.exports;var r=t[n]={exports:{}};return e[n](r,r.exports,o),r.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{const e=require("express");var t=o.n(e);const n=require("socket.io"),i=require("path");var r=o.n(i);const s=require("dotenv");var c=o.n(s),l=function(e,t,o,n){return new(o||(o=Promise))((function(i,r){function s(e){try{l(n.next(e))}catch(e){r(e)}}function c(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}l((n=n.apply(e,t||[])).next())}))};const a=new class{constructor(e,t){this.productList=[],this.db=o(514)(e),this.table=t,this.createTableIfNotExists()}createTableIfNotExists(){return l(this,void 0,void 0,(function*(){if(!(yield this.db.schema.hasTable(this.table)))try{yield this.db.schema.createTableIfNotExists(this.table,(e=>{e.increments("id").primary(),e.string("title"),e.integer("price"),e.string("thumbnail"),e.integer("timestamp")}))}catch(e){console.error(e)}}))}getAll(){return l(this,void 0,void 0,(function*(){return yield this.db.select("*").from(this.table)}))}getById(e){return l(this,void 0,void 0,(function*(){try{return(yield this.db.select("*").where("id",e).from(this.table))||{error:"Product not found."}}catch(e){console.log("Method getById: ",e)}return{error:"Fetch item method failed"}}))}addProduct(e){return l(this,void 0,void 0,(function*(){try{const t=Date.now();yield this.db.insert(Object.assign(Object.assign({},e),{timestamp:t})).into(this.table)}catch(e){console.log("Method save: ",e)}}))}updateProductById(e,t){return l(this,void 0,void 0,(function*(){try{yield this.db.where("id",e).update({title:t.name,price:t.price,thumbnail:t.photoURL}).from(this.table)}catch(e){console.log("Method update: ",e)}}))}deleteProductById(e){return l(this,void 0,void 0,(function*(){try{yield this.db.delete("*").where("id",e).from(this.table)}catch(e){console.log("Method deleteById: ",e)}}))}}({client:"mysql",connection:{host:"127.0.0.1",port:3306,user:"root",password:"",database:"Clase_16"},pool:{min:0,max:7}},"products"),d=require("fs");var u=o.n(d);const h=require("normalizr"),g=(e,t)=>{const o=new h.schema.Entity("author",{},{idAttribute:"email"}),n=new h.schema.Entity("message",{author:o},{idAttribute:"id"}),i=new h.schema.Entity("messages",{messages:[n]},{idAttribute:"id"});return"normalize"==e?(0,h.normalize)({id:"messages",messages:t},i):(0,h.denormalize)(t.result,i,t.entities)},v=require("util");var m=o.n(v),f=function(e,t,o,n){return new(o||(o=Promise))((function(i,r){function s(e){try{l(n.next(e))}catch(e){r(e)}}function c(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}l((n=n.apply(e,t||[])).next())}))};function p(e){console.log(m().inspect(e,!1,12,!0))}const y=new class extends class{constructor(e){this.filePath=e,u().existsSync(`./${this.filePath}`)||u().promises.writeFile(`./${this.filePath}`,"").then((()=>console.log(`${this.filePath} created`)))}}{constructor(){super("./src/db/chat.json")}readChatFromFile(){return f(this,void 0,void 0,(function*(){try{const e=yield u().promises.readFile(this.filePath,"utf8"),t=JSON.parse(e),o=g("denormalize",t);return console.log("Denormalized"),p(o),o}catch(e){console.log("File cannot be read "+e)}}))}writeChatToFile(e){return f(this,void 0,void 0,(function*(){try{const t=g("normalize",e);console.log("Normalized"),p(t),yield u().promises.writeFile(this.filePath,JSON.stringify(t,null,2))}catch(e){console.log("File cannot be written "+e)}}))}},b=require("cookie-parser");var w=o.n(b);const x=require("express-session");var P=o.n(x);const j=require("connect-mongo");var q=o.n(j),N=function(e,t,o,n){return new(o||(o=Promise))((function(i,r){function s(e){try{l(n.next(e))}catch(e){r(e)}}function c(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}l((n=n.apply(e,t||[])).next())}))};c().config();const z=process.env.PORT,O=t()(),F=O.listen(z,(()=>{console.log(`Server listening on port: ${z}`)})),A=new n.Server(F);O.use(t().static(r().join(__dirname,"../public"))),O.use(w()()),O.use(t().json()),O.use(t().urlencoded({extended:!0})),O.set("views",r().join(__dirname,"../public")),O.set("view engine","ejs"),O.use(P()({store:q().create({mongoUrl:"mongodb+srv://cesarb03:q1w2e3@project-backend.lwnru.mongodb.net/?retryWrites=true&w=majority",mongoOptions:{useNewUrlParser:!0,useUnifiedTopology:!0}}),secret:"coderhouse",resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:3e4}})),O.get("/",(function(e,t,o){var n;(null===(n=e.session)||void 0===n?void 0:n.user)?(console.log("Acá llego, SI existe sesion"),o()):(console.log("Acá llego, NO existe sesion"),t.redirect("/login"))}),((e,t)=>{const o=e.session.user.user;t.render("home.ejs",{userName:o})})),O.get("/login",((e,t)=>{if(e.session.user)return t.redirect("/");t.render("login.ejs")})),O.post("/login",((e,t)=>{try{const o=e.body;e.session.user=o,t.redirect("/")}catch(e){t.json({error:!0,message:e})}})),O.get("/logout",((e,t)=>{var o,n;if(null===(o=e.session)||void 0===o?void 0:o.user){const o=(null===(n=e.session)||void 0===n?void 0:n.user).user;return e.session.destroy((e=>console.log(e))),t.render("logout.ejs",{userName:o})}t.redirect("/login")}));let I=[];A.on("connection",(e=>N(void 0,void 0,void 0,(function*(){console.log(`Se conectó un usuario: ${e.id}`),e.emit("server:product",yield a.getAll()),e.emit("server:message",I),e.on("client:product",(e=>N(void 0,void 0,void 0,(function*(){a.addProduct(e),A.emit("server:product",yield a.getAll())})))),e.on("client:message",(e=>N(void 0,void 0,void 0,(function*(){e.id=I.length+1,I.push(e),y.writeChatToFile(I);const t=I,o=g("normalize",I),n=JSON.stringify(o).length,i=JSON.stringify(t).length;let r=Math.round(100*n/i);console.log(`Compression Rate: ${(100-r).toFixed(2)}%`),console.log(`Length Normalized: ${n}`),console.log(`Length Denormalized: ${i}`),A.emit("server:message",I)}))))}))))})()})();